name: Build and Deploy Blog

on:
  repository_dispatch:
    types: [docs-updated]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1ï¸âƒ£ æ£€å‡º Hexo æºç ä»“åº“ (Repo B)
      - name: Checkout Repo B (Hexo Source)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ æ£€å‡ºå†…å®¹ä»“åº“ (Repo A)
      - name: Checkout Repo A (Content)
        uses: actions/checkout@v4
        with:
          repository: HachGo/hexo-blog-content
          path: ./content-source
          token: ${{ secrets.DEPLOY_PAT_NEW }}

      # 3ï¸âƒ£ åŒæ­¥å†…å®¹æ–‡ä»¶
      - name: Sync Content Files to Hexo Source
        run: |
          echo "ğŸ› ï¸ æ­£åœ¨åˆ›å»º Hexo æ ¸å¿ƒç›®å½•ç»“æ„..."
          mkdir -p ./source/_posts/

          echo "ğŸ§¹ æ¸…ç†æ—§å†…å®¹..."
          rm -rf ./source/_posts/*

          echo "ğŸ“¦ åŒæ­¥æ–°å†…å®¹..."
          # âœ… å¦‚æœå†…å®¹ä»“åº“æ˜¯ç›´æ¥æ”¾ .md æ–‡ä»¶åœ¨æ ¹ç›®å½•ï¼Œè¯·ç”¨è¿™æ¡å‘½ä»¤ï¼š
          rsync -av --include='*.md' --exclude='*' ./content-source/ ./source/_posts/

          echo "âœ… å†…å®¹åŒæ­¥å®Œæˆã€‚æ–‡ç« å·²å¤åˆ¶åˆ° ./source/_posts/"
          echo "å½“å‰ _posts å†…å®¹:"
          ls -al ./source/_posts/

      # 4ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 5ï¸âƒ£ ç¼“å­˜ npm ä¾èµ–
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 6ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      # 7ï¸âƒ£ ç”Ÿæˆé™æ€æ–‡ä»¶
      - name: Build Hexo Site
        run: |
          echo "ğŸ§± å¼€å§‹æ„å»º Hexo åšå®¢..."
          npx hexo clean
          npx hexo generate
          echo "âœ… Hexo æ„å»ºå®Œæˆï¼Œç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -al ./public || echo "âš ï¸ æ²¡æœ‰ç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ Hexo æ—¥å¿—"

      # 8ï¸âƒ£ éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        env:
          GIT_AUTHOR_NAME: ${{ secrets.GIT_AUTHOR_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.GIT_AUTHOR_EMAIL }}
          GIT_COMMITTER_NAME: ${{ secrets.GIT_COMMITTER_NAME }}
          GIT_COMMITTER_EMAIL: ${{ secrets.GIT_COMMITTER_EMAIL }}
        run: |
          echo "ğŸ› ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "${GIT_AUTHOR_NAME:-GitHub Actions}"
          git config --global user.email "${GIT_AUTHOR_EMAIL:-actions@github.com}"

          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° GitHub Pages..."
          npx hexo deploy
