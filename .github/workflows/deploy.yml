# æ–‡ä»¶è·¯å¾„: .github/workflows/deploy.yml
# åŠŸèƒ½: ä» Repo A (å†…å®¹ä»“åº“) åŒæ­¥å†…å®¹ï¼Œåœ¨ Repo B (æºç ä»“åº“) æ„å»ºï¼Œ
#      ç„¶åéƒ¨ç½²åˆ° Repo C (GitHub Pages ä»“åº“)

name: Build and Deploy Blog

on:
  repository_dispatch:
    types: [docs-updated] # ç›‘å¬ Repo A è§¦å‘çš„ webhook ä¿¡å·
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸å†™å…¥ Repo Bï¼Œç”¨äºéƒ¨ç½²

    steps:
      # --------------------------
      # 1ï¸âƒ£ æ£€å‡ºå½“å‰ä»“åº“ (Hexo æºç ä»“åº“, Repo B)
      # --------------------------
      - name: Checkout Repo B (Hexo Source)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------
      # 2ï¸âƒ£ æ£€å‡ºå†…å®¹ä»“åº“ (Repo A)
      # --------------------------
      - name: Checkout Repo A (Content)
        uses: actions/checkout@v4
        with:
          repository: HachGo/hexo-blog-content   # å†…å®¹ä»“åº“
          path: ./content-source
          token: ${{ secrets.DEPLOY_PAT_NEW }}   # å¿…é¡»æœ‰ repo å…¨æƒé™

      # --------------------------
      # 3ï¸âƒ£ åŒæ­¥å†…å®¹æ–‡ä»¶
      # --------------------------
      - name: Sync Content Files to Hexo Source
        run: |
          mkdir -p ./source/_posts/
          echo "ğŸ§¹ æ¸…ç†æ—§å†…å®¹..."
          rm -rf ./source/_posts/*
          echo "ğŸ“¦ åŒæ­¥æ–°å†…å®¹..."
          rsync -av --delete ./content-source/ ./source/_posts/
          rm -rf ./content-source/.git
          echo "âœ… å†…å®¹åŒæ­¥å®Œæˆã€‚"

      # --------------------------
      # 4ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      # --------------------------
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --------------------------
      # 5ï¸âƒ£ ç¼“å­˜ npm ä¾èµ– (åŠ å¿«æ„å»º)
      # --------------------------
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # --------------------------
      # 6ï¸âƒ£ å®‰è£…ä¾èµ–
      # --------------------------
      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      # --------------------------
      # 7ï¸âƒ£ ç”Ÿæˆé™æ€æ–‡ä»¶
      # --------------------------
      - name: Build Hexo Site
        run: |
          npx hexo clean
          npx hexo generate

      # --------------------------
      # 8ï¸âƒ£ éƒ¨ç½²åˆ° GitHub Pages (Repo C)
      # --------------------------
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.DEPLOY_PAT_NEW }}   # âœ… ä¿®å¤å…³é”®é—®é¢˜ï¼šå¿…é¡»æ”¾åœ¨ with å†…
          external_repository: HachGo/HachGo.github.io     # Pages ä»“åº“
          publish_branch: main                             # ç›®æ ‡åˆ†æ”¯
          publish_dir: ./public                            # Hexo è¾“å‡ºç›®å½•
          commit_message: "ğŸš€ Deploy from Hexo build: ${{ github.run_number }}"
